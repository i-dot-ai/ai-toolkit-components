name: Test Applications

on:
    push:
        branches:
        - main
    pull_request:
    workflow_dispatch:

jobs:
  wait-for-components:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for component build and test to succeed
        if: github.event_name != 'workflow_dispatch'
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          check-regexp: 'build-and-test'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  discover:
    needs: wait-for-components
    runs-on: ubuntu-latest
    outputs:
      applications: ${{ steps.find.outputs.applications }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find applications
        id: find
        run: |
          applications=$(ls -d applications/*/ | xargs -n1 basename | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "applications=$applications" >> $GITHUB_OUTPUT

  test:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        application: ${{ fromJson(needs.discover.outputs.applications) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          python-version-file: .python-version

      - name: Sync dependencies
        run: uv sync

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Build component images
        run: |
          set -e
          docker compose build

      - name: Test application
        run: |
          mkdir -p results
          ./run_tests.sh application ${{ matrix.application }} -- \
            --junitxml="results/application-${{ matrix.application }}.xml"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.application }}
          path: results/application-${{ matrix.application }}.xml

  publish-results:
    needs: [discover, test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true
          path: results

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: results/application-*.xml
          check_name: Application Test Results
