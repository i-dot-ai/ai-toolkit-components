name: Docker Build and Test

on:
   # Trigger on pull requests, pushes to main branch, and manual workflow dispatch
    push:
        branches:
        - main
    pull_request:
    workflow_dispatch:

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      components: ${{ steps.find.outputs.components }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find components
        id: find
        run: |
          components=$(ls -d components/*/ | xargs -n1 basename | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "components=$components" >> $GITHUB_OUTPUT

  build-and-test:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        component: ${{ fromJson(needs.discover.outputs.components) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          python-version-file: .python-version

      - name: Sync dependencies
        run: uv sync

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build component image
        run: docker compose build ${{ matrix.component }}

      - name: Test component container
        run: |
          mkdir -p results
          ./run_tests.sh component ${{ matrix.component }} -- \
            --junitxml="results/component-${{ matrix.component }}.xml"

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.component }}
          path: results/component-${{ matrix.component }}.xml

  publish-results:
    needs: [discover, build-and-test]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true
          path: results

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: results/component-*.xml
          check_name: Component Test Results
